name: Create Tag

env:
  NODE_VERSION: 20.x # è®¾ç½® Node.js ç‰ˆæœ¬ç¯å¢ƒå˜é‡

on:
  push:
    branches:
      - main

jobs:
  # =====================
  # Job 1: è‡ªåŠ¨åŒ–è¯­ä¹‰åŒ–ç‰ˆæœ¬å‘å¸ƒï¼ˆç”Ÿæˆç‰ˆæœ¬å·ã€æ‰“ tagã€æ›´æ–° CHANGELOGï¼‰
  # =====================
  release:
    name: ğŸš€ Semantic ç‰ˆæœ¬å‘å¸ƒ
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    # è·³è¿‡ CI çš„æäº¤
    if: "!contains(github.event.head_commit.message, 'skip ci')"

    outputs:
      new_release_published: ${{ steps.release.outputs.new_release_published }}
      new_release_version: ${{ steps.release.outputs.new_release_version }}
      current_tag: ${{ steps.release.outputs.current_tag }}
      previous_tag: ${{ steps.release.outputs.previous_tag }}
      changelog_preview: ${{ steps.release.outputs.changelog_preview }}

    steps:
      - name: ğŸ” 1. æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å¿…é¡»å®Œæ•´å†å²ä»¥æ”¯æŒ semantic-release åˆ¤æ–­å˜æ›´

      - name: âš™ï¸ 2. è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ 3. å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ“¢ 4. æ‰§è¡Œ semantic-release
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.MY_PERSONAL_TOKEN }}
        run: |
          echo "ğŸ” 4.1 å¼€å§‹æ‰§è¡Œ semantic-release..."
          set +e  # å…è®¸æ•è·é”™è¯¯è€Œä¸ç«‹å³é€€å‡º
          OUTPUT=$(npx semantic-release --debug 2>&1)
          EXIT_CODE=$?
          set -e

          echo "ğŸ“‹ 4.2 semantic-release æ‰§è¡Œç»“æœï¼š"
          echo "$OUTPUT"

          # æ£€æŸ¥æ˜¯å¦å‘å¸ƒäº†æ–°ç‰ˆæœ¬
          if echo "$OUTPUT" | grep -q "Published release"; then
            echo "âœ… 4.3 æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬å·²å‘å¸ƒ"

            # æå–æ–°æ—§ç‰ˆæœ¬å·
            NEW_VERSION=$(echo "$OUTPUT" | grep -oP 'The next release version is \K\d+\.\d+\.\d+')
            PREVIOUS_TAG=$(git tag -l 'v*' --sort=-version:refname | grep -v "$NEW_VERSION" | head -n1 || echo "")

            # è®¾ç½®è¾“å‡ºå˜é‡
            echo "new_release_published=true" >> $GITHUB_OUTPUT
            echo "new_release_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "current_tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

            # æå– CHANGELOG é¢„è§ˆï¼ˆæœ€å¤šå‰ 5 è¡Œï¼‰
            if [[ -f "CHANGELOG.md" ]]; then
              PREVIEW=$(grep -A 5 "^## \\[v\\?$NEW_VERSION\\?\\]" CHANGELOG.md | head -n 5 | sed "s/'/''/g" | tr '\n' ' ')
              echo "changelog_preview='$PREVIEW'" >> $GITHUB_OUTPUT
            fi

            echo "ğŸ‰ å‘å¸ƒæˆåŠŸï¼šv$NEW_VERSION"
          else
            echo "â„¹ï¸ 4.4 æ— éœ€å‘å¸ƒæ–°ç‰ˆæœ¬ï¼ˆæ— ç¬¦åˆè§„åˆ™çš„æäº¤ï¼‰"
            echo "new_release_published=false" >> $GITHUB_OUTPUT
            echo "new_release_version=" >> $GITHUB_OUTPUT
            echo "current_tag=" >> $GITHUB_OUTPUT
            echo "previous_tag=" >> $GITHUB_OUTPUT
            echo "changelog_preview=" >> $GITHUB_OUTPUT
          fi

          # å¼ºåˆ¶è¿”å›åŸå§‹ exit codeï¼Œç¡®ä¿ CI æ­£ç¡®åæ˜ å‘å¸ƒå¤±è´¥
          exit $EXIT_CODE

      - name: ğŸ 5. è°ƒè¯•è¾“å‡º
        if: always()
        run: |
          echo "âœ… ==== LOG === âœ…"
          echo "ğŸ‘‰ éœ€è¦å‘å¸ƒ : ${{ steps.release.outputs.new_release_published }}"
          echo "ğŸ‘‰ å½“å‰ç‰ˆæœ¬: ${{ steps.release.outputs.new_release_version }}"
          echo "ğŸ‘‰ å½“å‰ç‰ˆæœ¬  Tag: ${{ steps.release.outputs.current_tag }}"
          echo "ğŸ‘‰ ä¸Šä¸ªç‰ˆæœ¬ Tag: ${{ steps.release.outputs.previous_tag }}"
          echo "ğŸ‘‰ æ—¥å¿—é¢„è§ˆ: ${{ steps.release.outputs.changelog_preview }}"
